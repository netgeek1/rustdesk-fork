name: Flutter client - 20251001

on:
  workflow_run:
    workflows: ["Flutter Nightly Build"]
    types:
      - completed

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: DEBUG: Check files & placeholders
        shell: bash
        run: |
          echo "Running debug for OS: $RUNNER_OS"
          FILES="
            flutter/lib/src/constants.dart
            flutter/lib/src/server_constants.dart
            flutter/lib/config.dart
            libs/hbb_common/src/config.rs
            libs/hbbs/src/config.rs
            libs/hbbr/src/config.rs
          "
          for f in $FILES; do
            if [ -f "$f" ]; then
              echo "✅ Exists: $f"
            else
              echo "❌ MISSING: $f"
            fi
          done

          echo "Checking for default server strings..."
          grep -R "rustdesk" -n . || echo "No matches"
          grep -R "rendezvous" -n . || echo "No matches"

      - name: DEBUG: Confirm secrets exist
        shell: bash
        run: |
          echo "RENDEZVOUS_SERVER is ${RENEZVOUS_SERVER:+set}"
          echo "RS_PUB_KEY is ${RS_PUB_KEY:+set}"

      - name: Inject RENDEZVOUS_SERVER & RS_PUB_KEY
        shell: bash
        run: |
          FILES="
            flutter/lib/src/constants.dart
            flutter/lib/src/server_constants.dart
            flutter/lib/config.dart
            libs/hbb_common/src/config.rs
            libs/hbbs/src/config.rs
            libs/hbbr/src/config.rs
          "
          for f in $FILES; do
            if [ -f "$f" ]; then
              cp "$f" "$f.bak"
              sed -i "s|REPLACE_WITH_RENDEZVOUS_SERVER|${{ secrets.RENDEZVOUS_SERVER }}|g" "$f"
              sed -i "s|REPLACE_WITH_RS_PUB_KEY|${{ secrets.RS_PUB_KEY }}|g" "$f"
              sed -i "s|RS_PUB_KEY_PLACEHOLDER|${{ secrets.RS_PUB_KEY }}|g" "$f"
              sed -i "s|rendezvous.rustdesk.com|${{ secrets.RENDEZVOUS_SERVER }}|g" "$f"
              sed -i "s|https://rendezvous.rustdesk.com|${{ secrets.RENDEZVOUS_SERVER }}|g" "$f"
              echo "Patched $f"
            fi
          done

      - name: Build Flutter Linux
        run: |
          flutter pub get
          flutter build linux --release

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: DEBUG: Check files & placeholders
        shell: bash
        run: |
          echo "Running debug for OS: $RUNNER_OS"
          FILES="
            flutter/lib/src/constants.dart
            flutter/lib/src/server_constants.dart
            flutter/lib/config.dart
            libs/hbb_common/src/config.rs
            libs/hbbs/src/config.rs
            libs/hbbr/src/config.rs
          "
          for f in $FILES; do
            if [ -f "$f" ]; then
              echo "✅ Exists: $f"
            else
              echo "❌ MISSING: $f"
            fi
          done

          echo "Checking for default server strings..."
          grep -R "rustdesk" -n . || echo "No matches"
          grep -R "rendezvous" -n . || echo "No matches"

      - name: DEBUG: Confirm secrets exist
        shell: bash
        run: |
          echo "RENDEZVOUS_SERVER is ${RENEZVOUS_SERVER:+set}"
          echo "RS_PUB_KEY is ${RS_PUB_KEY:+set}"

      - name: Inject RENDEZVOUS_SERVER & RS_PUB_KEY
        shell: bash
        run: |
          FILES="
            flutter/lib/src/constants.dart
            flutter/lib/src/server_constants.dart
            flutter/lib/config.dart
            libs/hbb_common/src/config.rs
            libs/hbbs/src/config.rs
            libs/hbbr/src/config.rs
          "
          for f in $FILES; do
            if [ -f "$f" ]; then
              cp "$f" "$f.bak"
              sed -i '' "s|REPLACE_WITH_RENDEZVOUS_SERVER|${{ secrets.RENDEZVOUS_SERVER }}|g" "$f"
              sed -i '' "s|REPLACE_WITH_RS_PUB_KEY|${{ secrets.RS_PUB_KEY }}|g" "$f"
              sed -i '' "s|RS_PUB_KEY_PLACEHOLDER|${{ secrets.RS_PUB_KEY }}|g" "$f"
              sed -i '' "s|rendezvous.rustdesk.com|${{ secrets.RENDEZVOUS_SERVER }}|g" "$f"
              sed -i '' "s|https://rendezvous.rustdesk.com|${{ secrets.RENDEZVOUS_SERVER }}|g" "$f"
              echo "Patched $f"
            fi
          done

      - name: Build Flutter macOS
        run: |
          flutter pub get
          flutter build macos --release

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: DEBUG: Check files & placeholders
        shell: pwsh
        run: |
          $files = @(
            'flutter\lib\src\constants.dart',
            'flutter\lib\src\server_constants.dart',
            'flutter\lib\config.dart',
            'libs\hbb_common\src\config.rs',
            'libs\hbbs\src\config.rs',
            'libs\hbbr\src\config.rs'
          )
          foreach ($f in $files) {
            if (Test-Path $f) { Write-Host "✅ Exists: $f" } else { Write-Host "❌ MISSING: $f" }
          }

          Write-Host "Searching for default server references..."
          Get-ChildItem -Recurse | Select-String -Pattern "rustdesk|rendezvous" | ForEach-Object { Write-Host $_ }

      - name: DEBUG: Confirm secrets exist
        shell: pwsh
        run: |
          if ($Env:RENDEZVOUS_SERVER) { Write-Host "✅ RENDEZVOUS_SERVER set" } else { Write-Host "❌ RENDEZVOUS_SERVER missing" }
          if ($Env:RS_PUB_KEY) { Write-Host "✅ RS_PUB_KEY set" } else { Write-Host "❌ RS_PUB_KEY missing" }

      - name: Inject RENDEZVOUS_SERVER & RS_PUB_KEY
        shell: pwsh
        run: |
          $files = @(
            'flutter\lib\src\constants.dart',
            'flutter\lib\src\server_constants.dart',
            'flutter\lib\config.dart',
            'libs\hbb_common\src\config.rs',
            'libs\hbbs\src\config.rs',
            'libs\hbbr\src\config.rs'
          )
          foreach ($f in $files) {
            if (Test-Path $f) {
              Copy-Item $f "$f.bak" -Force
              (Get-Content $f) -Raw `
                -Replace 'REPLACE_WITH_RENDEZVOUS_SERVER', '${{ secrets.RENDEZVOUS_SERVER }}' `
                -Replace 'REPLACE_WITH_RS_PUB_KEY', '${{ secrets.RS_PUB_KEY }}' `
                -Replace 'RS_PUB_KEY_PLACEHOLDER', '${{ secrets.RS_PUB_KEY }}' `
                -Replace 'rendezvous.rustdesk.com', '${{ secrets.RENDEZVOUS_SERVER }}' `
                -Replace 'https://rendezvous.rustdesk.com', '${{ secrets.RENDEZVOUS_SERVER }}' `
                | Set-Content $f
              Write-Host "Patched $f"
            }
          }

      - name: Build Flutter Windows
        run: |
          flutter pub get
          flutter build windows --release
